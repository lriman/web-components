"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.ChessboardView=exports.SPRITE_LOADING_STATUS=void 0;var _Svg=require("./Svg");var _ChessboardMoveInput=require("./ChessboardMoveInput");var _ChessboardPiecesAnimation=require("./ChessboardPiecesAnimation");var _constants=require("../_constants");var _utils=require("./_utils");function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor;}var SPRITE_LOADING_STATUS={notLoaded:1,loading:2,loaded:3};exports.SPRITE_LOADING_STATUS=SPRITE_LOADING_STATUS;var ChessboardView=/*#__PURE__*/function(){function ChessboardView(chessboard,callbackAfterCreation){_classCallCheck(this,ChessboardView);this.animationRunning=false;this.currentAnimation=null;this.callbackAfterCreation=callbackAfterCreation;this.chessboard=chessboard;this.spriteLoadWaitingTries=0;this.prepareLoadSprite();}_createClass(ChessboardView,[{key:"prepareLoadSprite",value:function prepareLoadSprite(){var _this=this;var func=arguments.length>0&&arguments[0]!==undefined?arguments[0]:function(){};this.loadSprite(this.chessboard.state,function(){_this.spriteLoadWaitDelay=100;_this.moveInput=new _ChessboardMoveInput.ChessboardMoveInput(_this,_this.chessboard.state,_this.chessboard.props,_this.moveStartCallback.bind(_this),_this.moveDoneCallback.bind(_this),_this.moveCanceledCallback.bind(_this));_this.animationQueue=[];if(_this.chessboard.props.responsive){_this.resizeListener=_this.handleResize.bind(_this);window.addEventListener('resize',_this.resizeListener);}_this.pointerDownListener=_this.pointerDownHandler.bind(_this);_this.chessboard.element.addEventListener('mousedown',_this.pointerDownListener);_this.chessboard.element.addEventListener('touchstart',_this.pointerDownListener);_this.createSvgAndGroups();_this.updateMetrics();_this.callbackAfterCreation();func();});}},{key:"pointerDownHandler",value:function pointerDownHandler(e){this.moveInput.onPointerDown(e);}},{key:"destroy",value:function destroy(){this.moveInput.destroy();window.removeEventListener('resize',this.resizeListener);this.chessboard.element.removeEventListener('mousedown',this.pointerDownListener);this.chessboard.element.removeEventListener('touchstart',this.pointerDownListener);window.clearTimeout(this.resizeDebounce);window.clearTimeout(this.redrawDebounce);window.clearTimeout(this.drawPiecesDebounce);window.clearTimeout(this.drawMarkersDebounce);_Svg.Svg.removeElement(this.svg);this.animationQueue=[];if(this.currentAnimation){window.cancelAnimationFrame(this.currentAnimation.frameHandle);}if(!document.querySelector('.cm-chessboard'))(0,_utils.removeSpriteSvg)(_Svg.Svg);ChessboardView.spriteLoadingStatus=SPRITE_LOADING_STATUS.notLoaded;}// Sprite //
},{key:"loadSprite",value:function loadSprite(props,callback){var _this2=this;var spriteSvg=document.getElementById('board-spriteSvg');if(spriteSvg&&this.chessboard.state){ChessboardView.spriteLoadingStatus=SPRITE_LOADING_STATUS.loaded;callback();return;}if(ChessboardView.spriteLoadingStatus===SPRITE_LOADING_STATUS.notLoaded){ChessboardView.spriteLoadingStatus=SPRITE_LOADING_STATUS.loading;_Svg.Svg.loadSprite(props.sprite,['wk','wq','wr','wb','wn','wp','bk','bq','br','bb','bn','bp','marker1','marker2','pointer','trash'],function(){ChessboardView.spriteLoadingStatus=SPRITE_LOADING_STATUS.loaded;callback();},this.chessboard.state.grid,this.chessboard.state.id);}else if(ChessboardView.spriteLoadingStatus===SPRITE_LOADING_STATUS.loading){setTimeout(function(){_this2.spriteLoadWaitingTries+=1;if(_this2.spriteLoadWaitingTries<100){_this2.loadSprite(props,callback);}},this.spriteLoadWaitDelay);}else if(ChessboardView.spriteLoadingStatus===SPRITE_LOADING_STATUS.loaded){callback();}}// Draw //
},{key:"createSvgAndGroups",value:function createSvgAndGroups(){if(this.svg){_Svg.Svg.removeElement(this.svg);}this.svg=_Svg.Svg.createSvg(this.chessboard.element);this.svg.setAttribute('class',"cm-chessboard");this.svg.setAttribute('data-index',this.chessboard.state.id);this.updateMetrics();this.boardGroup=_Svg.Svg.addElement(this.svg,'g',{"class":'board'});this.coordinatesGroup=_Svg.Svg.addElement(this.svg,'g',{'pointer-events':'none'});this.piecesGroup=_Svg.Svg.addElement(this.svg,'g',{'pointer-events':'none',cursor:'pointer'});this.markersGroup=_Svg.Svg.addElement(this.svg,'g',{'pointer-events':'none'});this.arrowsGroup=_Svg.Svg.addElement(this.svg,'g',{'pointer-events':'none'});}},{key:"updateMetrics",value:function updateMetrics(){this.width=this.chessboard.element.offsetWidth;this.height=this.chessboard.element.offsetHeight;if(this.chessboard.props.showBorder){this.borderSize=this.width/18;}else{this.borderSize=0;}this.innerWidth=this.width-2*this.borderSize;this.innerHeight=this.height-2*this.borderSize;this.squareWidth=this.innerWidth/8;this.squareHeight=this.innerHeight/8;this.scalingX=this.squareWidth/this.chessboard.state.grid;this.scalingY=this.squareHeight/this.chessboard.state.grid;this.pieceXTranslate=this.squareWidth/2-this.chessboard.state.grid*this.scalingY/2;}},{key:"handleResize",value:function handleResize(){var _this3=this;window.clearTimeout(this.resizeDebounce);this.resizeDebounce=setTimeout(function(){if(_this3.chessboard.element.offsetWidth!==_this3.width||_this3.chessboard.element.offsetHeight!==_this3.height){_this3.updateMetrics();_this3.redraw();}_this3.svg.setAttribute('width','100%');// safari bugfix
_this3.svg.setAttribute('height','100%');});}},{key:"redraw",value:function redraw(){var _this4=this;return new Promise(function(resolve){window.clearTimeout(_this4.redrawDebounce);_this4.redrawDebounce=setTimeout(function(){_this4.createSvgAndGroups();_this4.drawBoard();_this4.drawCoordinates();_this4.drawMarkers();_this4.setCursor();_this4.setHighLight((0,_utils.getMoveStyles)(_this4.chessboard.state.highLight,_this4.chessboard.state.boardStyles));setTimeout(function(){return _this4.chessboard.mountCallback();},15);});_this4.drawPiecesDebounced(_this4.chessboard.state.squares,function(){resolve();});_this4.drawMarkersDebounced();});}// Board //
},{key:"drawBoard",value:function drawBoard(){while(this.boardGroup.firstChild){this.boardGroup.removeChild(this.boardGroup.lastChild);}var boardBorder=_Svg.Svg.addElement(this.boardGroup,'rect',{width:this.width,height:this.height});boardBorder.style.strokeWidth=this.width-this.squareWidth*8;boardBorder.style.stroke=this.chessboard.state.boardStyles.borderStyles.background;boardBorder.style.fill='none';if(this.chessboard.props.showBorder){var innerPos=this.borderSize-this.borderSize/9;var borderInner=_Svg.Svg.addElement(this.boardGroup,'rect',{x:innerPos,y:innerPos});borderInner.setAttribute('class','border-inner');}for(var i=0;i<64;i+=1){var _this$chessboard,_this$chessboard$stat;var index=((_this$chessboard=this.chessboard)===null||_this$chessboard===void 0?void 0:(_this$chessboard$stat=_this$chessboard.state)===null||_this$chessboard$stat===void 0?void 0:_this$chessboard$stat.orientation)===_constants.COLOR.white?i:63-i;var squareColor=(9*index&8)===0?'darkSquareStyle':'lightSquareStyle';// eslint-disable-line
var point=this.squareIndexToPoint(index);var squareRect=_Svg.Svg.addElement(this.boardGroup,'rect',{x:point.x,y:point.y,width:this.squareWidth,height:this.squareHeight});var outRect=_Svg.Svg.addElement(this.boardGroup,'rect',{x:point.x,y:point.y,width:this.squareWidth,height:this.squareHeight,fill:'transparent'});outRect.setAttribute('data-index',"".concat(index));outRect.setAttribute('id',"".concat(index,"-").concat(this.chessboard.state.id));squareRect.style.fill=this.chessboard.state.boardStyles[squareColor].background;}}},{key:"getSquare",value:function getSquare(index){return this.boardGroup.querySelector("rect[data-index='".concat(index,"']"));}},{key:"setHighLight",value:function setHighLight(data){var _this5=this;if(!data)return;data.forEach(function(item){if(!item)return;var rect=_this5.getSquare(item[0]);if(rect)rect.style.fill=item[1].background;});}},{key:"removeHighLight",value:function removeHighLight(data){var _this6=this;if(!data)return;data.forEach(function(item){if(!item)return;var rect=_this6.getSquare(item[0]);if(rect)rect.style.fill='transparent';});}},{key:"drawCoordinates",value:function drawCoordinates(){if(!this.chessboard.props.showCoordinates){return;}var boardStyles=this.chessboard.state.boardStyles;while(this.coordinatesGroup.firstChild){this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);}var inline=!this.chessboard.props.showBorder;for(var file=0;file<8;file+=1){var _this$chessboard2,_this$chessboard2$sta;var x=this.borderSize+(18+this.chessboard.state.grid*file)*this.scalingX;var y=this.height-this.scalingY*8.5;if(inline){x+=this.scalingX*21.2;y=this.height-this.scalingY*1.5;}var textElement=_Svg.Svg.addElement(this.coordinatesGroup,'text',{x:x,y:y,style:"font-size: ".concat(inline?this.scalingY*7:this.scalingY*9,"px; fill: ").concat((0,_utils.getFileCoordinatesColor)(file,boardStyles,inline),"; user-select: none;")});if(((_this$chessboard2=this.chessboard)===null||_this$chessboard2===void 0?void 0:(_this$chessboard2$sta=_this$chessboard2.state)===null||_this$chessboard2$sta===void 0?void 0:_this$chessboard2$sta.orientation)===_constants.COLOR.white){textElement.textContent=inline?String.fromCharCode(97+file).toUpperCase():String.fromCharCode(97+file).toUpperCase();}else{textElement.textContent=inline?String.fromCharCode(104-file).toUpperCase():String.fromCharCode(104-file).toUpperCase();}}for(var rank=0;rank<8;rank+=1){var _this$chessboard3,_this$chessboard3$sta;var _x=this.borderSize/2.4;var _y=this.borderSize+24*this.scalingY+rank*this.squareHeight;if(inline){if(this.chessboard.props.showBorder){_x+=this.scalingX*10;_y-=this.scalingY*15;}else{_x+=this.scalingX*1.5;_y-=this.scalingY*17;}}var _textElement=_Svg.Svg.addElement(this.coordinatesGroup,'text',{x:_x,y:_y,style:"font-size: ".concat(inline?this.scalingY*7.3:this.scalingY*9,"px; fill: ").concat((0,_utils.getRankCoordinatesColor)(rank,boardStyles,inline),"; user-select: none;")});if(((_this$chessboard3=this.chessboard)===null||_this$chessboard3===void 0?void 0:(_this$chessboard3$sta=_this$chessboard3.state)===null||_this$chessboard3$sta===void 0?void 0:_this$chessboard3$sta.orientation)===_constants.COLOR.white){_textElement.textContent=8-rank;}else{_textElement.textContent=1+rank;}}}// Pieces //
},{key:"drawPiecesDebounced",value:function drawPiecesDebounced(){var _this7=this;var squares=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.chessboard.state.squares;var callback=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;window.clearTimeout(this.drawPiecesDebounce);this.drawPiecesDebounce=setTimeout(function(){_this7.drawPieces(squares);if(callback){callback();}});}},{key:"drawPieces",value:function drawPieces(){var squares=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.chessboard.state.squares;while(this.piecesGroup.firstChild){this.piecesGroup.removeChild(this.piecesGroup.lastChild);}for(var i=0;i<64;i+=1){var pieceName=squares[i];if(pieceName){this.drawPiece(i,pieceName);}}}},{key:"drawPiece",value:function drawPiece(index,pieceName){var pieceGroup=_Svg.Svg.addElement(this.piecesGroup,'g');pieceGroup.setAttribute('data-piece',pieceName);pieceGroup.setAttribute('data-index',index);var point=this.squareIndexToPoint(index);var transform=this.svg.createSVGTransform();transform.setTranslate(point.x,point.y);pieceGroup.transform.baseVal.appendItem(transform);var pieceUse=_Svg.Svg.addElement(pieceGroup,'use',{href:"#".concat(pieceName),"class":'piece'});// center on square
var transformTranslate=this.svg.createSVGTransform();transformTranslate.setTranslate(this.pieceXTranslate,0);pieceUse.transform.baseVal.appendItem(transformTranslate);// scale
var transformScale=this.svg.createSVGTransform();transformScale.setScale(this.scalingY,this.scalingY);pieceUse.transform.baseVal.appendItem(transformScale);return pieceGroup;}},{key:"setPieceVisibility",value:function setPieceVisibility(index){var visible=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var piece=this.getPiece(index);if(visible){piece.setAttribute('visibility','visible');}else{piece.setAttribute('visibility','hidden');}}},{key:"getPiece",value:function getPiece(index){return this.piecesGroup.querySelector("g[data-index='".concat(index,"']"));}// Markers //
},{key:"drawMarkersDebounced",value:function drawMarkersDebounced(){var _this8=this;window.clearTimeout(this.drawMarkersDebounce);this.drawMarkersDebounce=setTimeout(function(){_this8.drawMarkers();_this8.drawArrows();},10);}},{key:"drawMarkers",value:function drawMarkers(){var _this9=this;while((_this$markersGroup=this.markersGroup)!==null&&_this$markersGroup!==void 0&&_this$markersGroup.firstChild){var _this$markersGroup,_this$markersGroup2;this.markersGroup.removeChild((_this$markersGroup2=this.markersGroup)===null||_this$markersGroup2===void 0?void 0:_this$markersGroup2.firstChild);}this.chessboard.state.markers.forEach(function(marker){_this9.drawMarker(marker);});}},{key:"drawMarker",value:function drawMarker(marker){var markerGroup=_Svg.Svg.addElement(this.markersGroup,'g');markerGroup.setAttribute('data-index',marker.index);var point=this.squareIndexToPoint(marker.index);var transform=this.svg.createSVGTransform();transform.setTranslate(point.x,point.y);markerGroup.transform.baseVal.appendItem(transform);var markerUse=_Svg.Svg.addElement(markerGroup,'use',{href:"#".concat(marker.type.slice),stroke:marker.type.color,'pointer-events':'none'});var transformScale=this.svg.createSVGTransform();transformScale.setScale(this.scalingX,this.scalingY);markerUse.transform.baseVal.appendItem(transformScale);return markerGroup;}},{key:"drawArrows",value:function drawArrows(){var _this10=this;while((_this$arrowsGroup=this.arrowsGroup)!==null&&_this$arrowsGroup!==void 0&&_this$arrowsGroup.firstChild){var _this$arrowsGroup;this.arrowsGroup.removeChild(this.arrowsGroup.firstChild);}this.chessboard.state.arrows.forEach(function(arrow){_this10.drawArrow(arrow);});}},{key:"drawArrow",value:function drawArrow(arrow,remove){if(remove){var lastIndex=this.arrowsGroup.lastChild&&this.arrowsGroup.lastChild.getAttribute('data-index');var arrows=this.chessboard.state.arrows[this.chessboard.state.arrows.length-1]||{};if(lastIndex!=="".concat(arrows.from,"-").concat(arrows.to))_Svg.Svg.removeElement(this.arrowsGroup.lastChild);}if(arrow.from===arrow.to)return null;var arrowGroup=_Svg.Svg.addElement(this.arrowsGroup,'g');arrowGroup.setAttribute('data-index',"".concat(arrow.from,"-").concat(arrow.to));var strokeWidth=0.15*this.squareWidth;var _getArrowPoints=(0,_utils.getArrowPoints)(arrow,this.squareWidth,this.squareHeight,this.chessboard,this.borderSize),a=_getArrowPoints.a,b=_getArrowPoints.b;var dx=b.x-a.x;var dy=b.y-a.y;var rad=Math.atan2(dy,dx);var r=3*strokeWidth;var xo=Math.cos(rad)*r;var yo=Math.sin(rad)*r;return(0,_utils.getGradientArrow)(_Svg.Svg,arrow,arrowGroup,a,b,xo,yo,strokeWidth,rad);}// animation queue //
},{key:"animatePieces",value:function animatePieces(fromSquares,toSquares,callback){this.animationQueue.push({fromSquares:fromSquares,toSquares:toSquares,callback:callback});if(!this.animationRunning){this.nextPieceAnimationInQueue();}}},{key:"nextPieceAnimationInQueue",value:function nextPieceAnimationInQueue(){var _this11=this;var nextAnimation=this.animationQueue.shift();if(nextAnimation!==undefined){this.currentAnimation=new _ChessboardPiecesAnimation.ChessboardPiecesAnimation(// eslint-disable-line
this,nextAnimation.fromSquares,nextAnimation.toSquares,this.chessboard.props.animationDuration/(this.animationQueue.length+1),function(){if(!_this11.moveInput.dragablePiece){_this11.drawPieces(nextAnimation.toSquares);}_this11.nextPieceAnimationInQueue();if(nextAnimation.callback){nextAnimation.callback();}});}}// Callbacks //
},{key:"moveStartCallback",value:function moveStartCallback(index,piece,button){if(this.chessboard.moveInputCallback){return this.chessboard.moveInputCallback({chessboard:this.chessboard,type:_constants.INPUT_EVENT_TYPE.moveStart,square:_constants.SQUARE_COORDINATES[index],id:this.chessboard.state.id,piece:piece,button:button});}return true;}},{key:"moveDoneCallback",value:function moveDoneCallback(fromIndex,toIndex,piece){if(this.chessboard.moveInputCallback){return this.chessboard.moveInputCallback({chessboard:this.chessboard,type:_constants.INPUT_EVENT_TYPE.moveDone,squareFrom:_constants.SQUARE_COORDINATES[fromIndex],squareTo:_constants.SQUARE_COORDINATES[toIndex],id:this.chessboard.state.id,piece:piece});}return true;}},{key:"moveCanceledCallback",value:function moveCanceledCallback(){if(this.chessboard.moveInputCallback){this.chessboard.moveInputCallback({chessboard:this.chessboard,type:_constants.INPUT_EVENT_TYPE.moveCanceled,id:this.chessboard.state.id});}}// Helpers //
},{key:"setCursor",value:function setCursor(){var _this12=this;this.chessboard.initialization.then(function(){var _this12$chessboard,_this12$chessboard$st,_this12$chessboard2,_this12$chessboard2$s;if((_this12$chessboard=_this12.chessboard)!==null&&_this12$chessboard!==void 0&&(_this12$chessboard$st=_this12$chessboard.state)!==null&&_this12$chessboard$st!==void 0&&_this12$chessboard$st.inputWhiteEnabled||(_this12$chessboard2=_this12.chessboard)!==null&&_this12$chessboard2!==void 0&&(_this12$chessboard2$s=_this12$chessboard2.state)!==null&&_this12$chessboard2$s!==void 0&&_this12$chessboard2$s.inputBlackEnabled){_this12.boardGroup.setAttribute('class','board input-enabled');}else{_this12.boardGroup.setAttribute('class','board');}});}},{key:"squareIndexToPoint",value:function squareIndexToPoint(index){var _this$chessboard4,_this$chessboard4$sta;var x;var y;if(((_this$chessboard4=this.chessboard)===null||_this$chessboard4===void 0?void 0:(_this$chessboard4$sta=_this$chessboard4.state)===null||_this$chessboard4$sta===void 0?void 0:_this$chessboard4$sta.orientation)===_constants.COLOR.white){x=this.borderSize+index%8*this.squareWidth;y=this.borderSize+(7-Math.floor(index/8))*this.squareHeight;}else{x=this.borderSize+(7-index%8)*this.squareWidth;y=this.borderSize+Math.floor(index/8)*this.squareHeight;}return{x:x,y:y};}}]);return ChessboardView;}();exports.ChessboardView=ChessboardView;ChessboardView.spriteLoadingStatus=SPRITE_LOADING_STATUS.notLoaded;