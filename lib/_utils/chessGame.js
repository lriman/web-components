"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=exports.getHistoryPrevId=exports.getHistoryLastId=exports.getMoveIndex=exports.getHistory=exports.setHistoryTree=exports.getIncrementedIndexes=exports.getIsLittleTime=exports.getTimerTime=exports.getTimeLimit=exports.getCompetedGameTimeLeft=exports.getTimeControl=exports.getHighlightStyles=exports.getMoveSquareStyles=exports.getSquareStyles=exports.getGameSettings=exports.getPiecePositions=exports.isPromotion=exports.getSortedCapturedPieces=exports.getCapturedPiecesDiff=exports.PIECES_PRIORITY=void 0;var _moment=_interopRequireDefault(require("moment"));var _zeroPad=_interopRequireDefault(require("./zeroPad"));var _formatLabel=_interopRequireDefault(require("./formatLabel"));var _getTimeDiff=require("./getTimeDiff");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj};}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread();}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&Symbol.iterator in Object(iter))return Array.from(iter);}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}var PIECES_PRIORITY={p:1,n:2,b:3,r:4,q:5};exports.PIECES_PRIORITY=PIECES_PRIORITY;var setPromotionForDiff=function setPromotionForDiff(data,moveIndex){return data.moves.slice(0,moveIndex+1).reduce(function(acc,item){if(item.promotion){var indexP=acc[item.color].indexOf(item.piece);acc[item.color].splice(indexP,1);acc[item.color].push(item.promotion);}return acc;},{w:_toConsumableArray(data.captured.w),b:_toConsumableArray(data.captured.b)});};var getCapturedPiecesDiff=function getCapturedPiecesDiff(data,moveIndex){var _data$moves;if(!(data!==null&&data!==void 0&&(_data$moves=data.moves)!==null&&_data$moves!==void 0&&_data$moves.length))return null;var captured=setPromotionForDiff(data,moveIndex);return captured.w.reduce(function(acc,item){var indexW=acc.w.indexOf(item);var indexB=acc.b.indexOf(item);if(indexB>=0){acc.w.splice(indexW,1);acc.b.splice(indexB,1);}return acc;},{w:_toConsumableArray(captured.w),b:_toConsumableArray(captured.b)});};exports.getCapturedPiecesDiff=getCapturedPiecesDiff;var getSortedCapturedPieces=function getSortedCapturedPieces(captured){var w=(captured===null||captured===void 0?void 0:captured.w.sort(function(a,c){return PIECES_PRIORITY[c]-PIECES_PRIORITY[a];}))||[];var b=(captured===null||captured===void 0?void 0:captured.b.sort(function(a,c){return PIECES_PRIORITY[c]-PIECES_PRIORITY[a];}))||[];return{w:w,b:b};};exports.getSortedCapturedPieces=getSortedCapturedPieces;var isPromotion=function isPromotion(from,to,piece){if(from&&to){if(piece&&piece.color==='w'&&piece.type==='p'){return from.charAt(1)==='7'&&to.charAt(1)==='8';}if(piece&&piece.color==='b'&&piece.type==='p'){return from.charAt(1)==='2'&&to.charAt(1)==='1';}}return false;};exports.isPromotion=isPromotion;var getPiecePositions=function getPiecePositions(game,piece){var _ref;return(_ref=[]).concat.apply(_ref,_toConsumableArray(game.board())).map(function(p,index){if(p!==null&&p.type===piece.type&&p.color===piece.color){return index;}return null;}).filter(Number.isInteger).map(function(pieceIndex){var row='abcdefgh'[pieceIndex%8];var column=Math.ceil((64-pieceIndex)/8);return row+column;});};exports.getPiecePositions=getPiecePositions;var getGameSettings=function getGameSettings(profile,type){var _profile$settings;var settings=profile===null||profile===void 0?void 0:(_profile$settings=profile.settings)===null||_profile$settings===void 0?void 0:_profile$settings.game.filter(function(item){return item.type.includes(type);});return settings.length?settings[0]:{};};exports.getGameSettings=getGameSettings;var getSquareStyles=function getSquareStyles(pieceSquare,history,moveSquareStyles){var sourceSquare=history&&history.length&&history[history.length-1].from;var targetSquare=history&&history.length&&history[history.length-1].to;return _objectSpread(_objectSpread(_defineProperty({},pieceSquare,moveSquareStyles),history&&history.length&&_defineProperty({},sourceSquare,moveSquareStyles)),history&&history.length&&_defineProperty({},targetSquare,moveSquareStyles));};exports.getSquareStyles=getSquareStyles;var getMoveSquareStyles=function getMoveSquareStyles(move,moveSquareStyles){if(!move)return{};var sourceSquare=move&&move.from;var targetSquare=move&&move.to;return _objectSpread(_objectSpread({},move&&_defineProperty({},sourceSquare,moveSquareStyles)),move&&_defineProperty({},targetSquare,moveSquareStyles));};exports.getMoveSquareStyles=getMoveSquareStyles;var getHighlightStyles=function getHighlightStyles(sourceSquare,squaresToHighlight,highlightStyles){return[sourceSquare].concat(_toConsumableArray(squaresToHighlight)).reduce(function(a,c){return _objectSpread(_objectSpread({},a),_defineProperty({},c,highlightStyles));},{});};exports.getHighlightStyles=getHighlightStyles;var getTimeControl=function getTimeControl(data,labels){var separator=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'|';var showZero=arguments.length>3?arguments[3]:undefined;var timeLimit=data.timeLimit,timeAdd=data.timeAdd,ratingType=data.ratingType,type=data.type;if(!timeLimit)return null;if(ratingType==='offline'||type==='offline'){return labels!==null&&labels!==void 0&&labels.days?(0,_formatLabel["default"])(labels.days,{count:timeLimit/86400}):timeLimit/86400;}if(showZero)return"".concat(timeLimit/60).concat(separator).concat(timeAdd?"".concat(timeAdd):'0');var value="".concat(timeLimit/60).concat(timeAdd?"".concat(separator).concat(timeAdd):'');return labels!==null&&labels!==void 0&&labels.min?"".concat(value," ").concat(labels.min):value;};// Time section
exports.getTimeControl=getTimeControl;var getEndTime=function getEndTime(move){var _move$extra,_move$extra2;if(move!==null&&move!==void 0&&(_move$extra=move.extra)!==null&&_move$extra!==void 0&&_move$extra.drawAccept)return(_move$extra2=move.extra)===null||_move$extra2===void 0?void 0:_move$extra2.drawAccept;return move.ts;};var getCompetedGameTimeLeft=function getCompetedGameTimeLeft(data,index,color){var moveIndex=index+1;var moves=_toConsumableArray(data.moves);if(data.finishReason==='time_over'&&index===data.moves.length-1){moves.push({ts:data.finishTimestamp});moveIndex=index+2;}var computedTimeLimit=moves.slice(0,moveIndex).reduce(function(acc,item,i){if(i===0){acc.white-=(0,_getTimeDiff.getTimeDiff)(data.created,getEndTime(moves[i]),'milliseconds')-data.timeAdd*1000;}if(i%2===0&&i>=1){acc.white-=(0,_getTimeDiff.getTimeDiff)(moves[i-1].ts,getEndTime(moves[i]),'milliseconds')-data.timeAdd*1000;}else if(i%2!==0&&i>=1){acc.black-=(0,_getTimeDiff.getTimeDiff)(moves[i-1].ts,getEndTime(moves[i]),'milliseconds')-data.timeAdd*1000;}return acc;},{white:data.timeLimit*1000,black:data.timeLimit*1000});return computedTimeLimit[color];};exports.getCompetedGameTimeLeft=getCompetedGameTimeLeft;var getTimeLimit=function getTimeLimit(data,color){var moveIndex=data.moveIndex;if(data.status==='canceled')return data.timeLimit*1000;if(data.status==='finished')return getCompetedGameTimeLeft(data,moveIndex,color);var timeLeft=color==='white'?data.whiteRealLeftMs||data.whiteLeftMs:data.blackRealLeftMs||data.blackLeftMs;return timeLeft>0?timeLeft:0;};exports.getTimeLimit=getTimeLimit;var getTimerTime=function getTimerTime(time,labels,isMobile,showDaysZero){var days=time.days,hours=time.hours,minutes=time.minutes,seconds=time.seconds,milliseconds=time.milliseconds;if(days>=1){var _labels$time;return(0,_formatLabel["default"])(labels===null||labels===void 0?void 0:(_labels$time=labels.time)===null||_labels$time===void 0?void 0:_labels$time.days,{count:days});}if(days<1&&hours>=1){return"".concat((0,_zeroPad["default"])(hours),":").concat((0,_zeroPad["default"])(minutes));}if(!days&&!hours&&!minutes&&seconds<10&&seconds>0){return"00:".concat((0,_zeroPad["default"])(seconds)).concat(!isMobile?",".concat((0,_zeroPad["default"])(milliseconds).slice(0,1)):'');}return"".concat(showDaysZero?'00:':'').concat((0,_zeroPad["default"])(minutes),":").concat((0,_zeroPad["default"])(seconds));};exports.getTimerTime=getTimerTime;var getIsLittleTime=function getIsLittleTime(time,timeLimit){// timeLimit in milliseconds
var days=time.days,hours=time.hours,minutes=time.minutes,seconds=time.seconds;if(!timeLimit)return!days&&!hours&&!minutes&&seconds<10;var persent=_moment["default"].duration(time)*100/timeLimit;return persent<10;};// Tree section
exports.getIsLittleTime=getIsLittleTime;var getIncrementedIndexes=function getIncrementedIndexes(indexes){return[].concat(_toConsumableArray(indexes.slice(0,-1)),[indexes[indexes.length-1]+1]);};exports.getIncrementedIndexes=getIncrementedIndexes;var setHistoryTree=function setHistoryTree(item,history,moves,indexes){var lastIndex=moves.length-1;var lastMove=moves[lastIndex];if(indexes&&indexes.length>1)return setHistoryTree(item,history[indexes[0]].items[indexes[1]],moves,indexes.slice(2));if(!history.length||(history===null||history===void 0?void 0:history.length)-1===indexes[0]){history.push(lastMove);item.indexes=[].concat(_toConsumableArray(item.indexes.slice(0,-1)),[history.length-1]);}else if(history[indexes[0]+1]&&history[indexes[0]+1].san===lastMove.san){item.indexes=getIncrementedIndexes(item.indexes);}else if(history[indexes[0]+1]&&history[indexes[0]+1].items){if(history[indexes[0]+1].items.find(function(el){return el[0].san===lastMove.san;})){history[indexes[0]+1].items.forEach(function(elem,i){if(elem[0].san===lastMove.san){item.indexes=[].concat(_toConsumableArray(getIncrementedIndexes(item.indexes)),[i,0]);}});return null;}var i=history[indexes[0]+1].items.length;var lastInd=getIncrementedIndexes(item.indexes);var newItem=[lastMove];history[indexes[0]+1].items.push(newItem);item.indexes=[].concat(_toConsumableArray(lastInd),[i,0]);}else{var startInd=getIncrementedIndexes(item.indexes);history[indexes[0]+1].items=[[lastMove]];item.indexes=[].concat(_toConsumableArray(startInd),[0,0]);}return null;};exports.setHistoryTree=setHistoryTree;var getHistory=function getHistory(history,indexes){var result=[];(function flat(hist,ind){if(ind.length===1)result=[].concat(_toConsumableArray(result),_toConsumableArray(hist));else{var _result;(_result=result).push.apply(_result,_toConsumableArray(hist.slice(0,ind[0])));flat(hist[ind[0]].items[ind[1]],ind.slice(2));}})(history,indexes);return result;};exports.getHistory=getHistory;var getMoveIndex=function getMoveIndex(indexes){var filtered=indexes.filter(function(item,i){return!(i%2);});var res=filtered.reduce(function(acc,item){if(indexes)acc+=item;return acc;},0);return res;};exports.getMoveIndex=getMoveIndex;var getHistoryLastId=function getHistoryLastId(history,indexes){var _lastLine2;var lastLine=history;indexes.slice(0,-1).forEach(function(item,i){var _lastLine;if(i%2===0)lastLine=lastLine[item];else lastLine=(_lastLine=lastLine)===null||_lastLine===void 0?void 0:_lastLine.items[item];});return((_lastLine2=lastLine)===null||_lastLine2===void 0?void 0:_lastLine2.length)-1;};exports.getHistoryLastId=getHistoryLastId;var getHistoryPrevId=function getHistoryPrevId(indexes){if(indexes.length===1&&indexes[0]===0)return[-1];var newIndexes=[].concat(_toConsumableArray(indexes.slice(0,-1)),[indexes[indexes.length-1]-1]);if(newIndexes[newIndexes.length-1]<0){var lastInd=newIndexes.slice(0,-2);return[].concat(_toConsumableArray(lastInd.slice(0,-1)),[lastInd[lastInd.length-1]-1]);}return newIndexes;};exports.getHistoryPrevId=getHistoryPrevId;var _default={getSortedCapturedPieces:getSortedCapturedPieces,getCapturedPiecesDiff:getCapturedPiecesDiff,isPromotion:isPromotion,getGameSettings:getGameSettings,getSquareStyles:getSquareStyles,getMoveSquareStyles:getMoveSquareStyles,getHighlightStyles:getHighlightStyles,getPiecePositions:getPiecePositions,getTimeControl:getTimeControl,getCompetedGameTimeLeft:getCompetedGameTimeLeft,getTimeLimit:getTimeLimit,getIsLittleTime:getIsLittleTime,getIncrementedIndexes:getIncrementedIndexes,setHistoryTree:setHistoryTree,getHistory:getHistory,getMoveIndex:getMoveIndex,getHistoryLastId:getHistoryLastId,getHistoryPrevId:getHistoryPrevId};exports["default"]=_default;